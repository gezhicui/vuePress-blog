---
title: 重绘和重排及其优化
date: 2021-03-21 21:19:46
tags:
  - 浏览器
categories:
  - 浏览器
permalink: /pages/6050e9/
sidebar: auto
author:
  name: 杨雨翔
  link: https://github.com/gezhicui
---

在理解重绘重排之前，我们需要了解一下网页的生成过程：

## 一、网页生成过程

- HTML 被 HTML 解析器解析成 DOM 树
- css 则被 css 解析器解析成 CSSOM 树
- 结合 DOM 树和 CSSOM 树，生成一棵渲染树(Render Tree)
- 生成布局（flow），即将所有渲染树的所有节点进行平面合成
- 将布局绘制（paint）在屏幕上

第四步和第五步是最耗时的部分，这两步合起来，就是我们通常所说的**渲染**。

重绘不一定需要重排，重排必然会导致重绘

## 二、重排(回流，reflow)

### 概念：

当 DOM 的变化影响了元素的几何信息(DOM 对象的位置和尺寸大小)，浏览器需要重新计算元素的几何属性，将其安放在界面中的正确位置，这个过程叫做重排。

重排也叫回流,重排的过程以下面这种理解方式更清晰一些：

> 回流就好比向河里(文档流)扔了一块石头(dom 变化)，激起涟漪，然后引起周边水流受到波及，所以叫做回流

常见引起重排属性和方法

任何会改变元素几何信息(元素的位置和尺寸大小)的操作，都会触发重排，下面列一些栗子：

- 1）添加、删除可见的 dom

- 2）元素的位置改变

- 3）元素的尺寸改变（外边距、内边距、边框厚度、宽高等几何属性）

- 4）页面渲染初始化

- 5）浏览器窗口尺寸改变

- 6） 内容变化，比如用户在 input 框中输入文字

### 常见的引起重排的属性和方法

![](https://yangblogimg.oss-cn-hangzhou.aliyuncs.com/blogImg/重排属性方法.png)

## 三、重绘(Repaints)

### 概念

当一个元素的外观发生改变，但没有改变布局,重新把元素外观绘制出来的过程，叫做重绘。

### 常见的引起重绘的属性和方法

![](https://yangblogimg.oss-cn-hangzhou.aliyuncs.com/blogImg/重绘属性.png)

## 四、关键点

**重绘不一定需要重排，重排必然会导致重绘**

## 五、浏览器的渲染队列

### 正常渲染队列

思考以下代码将会触发几次渲染？

```js
div.style.left = '10px';
div.style.top = '10px';
div.style.width = '20px';
div.style.height = '20px';
```

根据我们上文的定义，这段代码理论上会触发`4次`重排+重绘，因为每一次都改变了元素的几何属性，实际上最后只触发了一次重排，这都得益于浏览器的**渲染队列机制**：

当我们修改了元素的几何属性，导致浏览器触发重排或重绘时。它会把该操作放进渲染队列，等到队列中的操作到了**一定的数量或者到了一定的时间间隔**时，浏览器就会批量执行这些操作。

### 强制刷新队列:

```js
div.style.left = '10px';
console.log(div.offsetLeft);
div.style.top = '10px';
console.log(div.offsetTop);
div.style.width = '20px';
console.log(div.offsetWidth);
div.style.height = '20px';
console.log(div.offsetHeight);
```

这段代码会触发 4 次重排+重绘，因为在 console 中你请求的这几个样式信息，无论何时浏览器都会立即执行渲染队列的任务，即使该值与你操作中修改的值没关联。

**因为队列中，可能会有影响到这些值的操作，为了给我们最精确的值，浏览器会立即重排+重绘。**

## 如何优化？

### CSS

- **在进行动画操作的时候，使用 `transform` 替代 top**

- **使用 `visibility` 替换 `display: none`** ，因为前者只会引起重绘，后者会引发回流（改变了布局)

- **避免使用`table`布局**，可能很小的一个小改动会造成整个 table 的重新布局。

- **尽可能在 DOM 树的最末端改变 class**，回流是不可避免的，但可以减少其影响。尽可能在 DOM 树的最末端改变 class，可以限制了回流的范围，使其影响尽可能少的节点。

- **避免设置多层内联样式**，css 选择符**从右往左**匹配查找，避免节点层级过多,保证**层级扁平。**

- **将动画效果应用到`position`属性为`absolute`或`fixed`的元素上**，避免影响其他元素的布局，这样只是一个重绘，而不是回流，同时，控制动画速度可以选择 `requestAnimationFrame`。

- **避免使用 CSS 表达式**，可能会引发回流。

- **CSS3 硬件加速**可以让`transform`、`opacity`、`filters`这些动画不会引起回流重绘 。但是对于动画的其它属性，比如 background-color 这些，还是会引起回流重绘的，不过它还是可以提升这些动画的性能。

### JS

- **避免频繁操作样式**，最好一次性重写`style`属性，或者将样式列表定义为`class`并一次性更改`class`属性。

- **避免频繁操作 DOM**，创建一个`documentFragment`，在它上面应用所有`DOM`操作，最后再把它添加到文档中。

- **避免频繁读取会引发回流/重绘的属性**，如果确实需要多次使用，就用一个变量缓存起来。

- **对具有复杂动画的元素使用绝对定位**，使它脱离文档流，否则会引起父元素及后续元素频繁回流。
