---
title: 重绘和重排
date: 2021-03-21 21:19:46
tags:
  - 浏览器
categories:
  - 浏览器
permalink: /pages/6050e9/
sidebar: auto
author:
  name: 杨雨翔
  link: https://github.com/gezhicui
---

在理解重绘重排之前，我们需要了解一下网页的生成过程：

## 一、网页生成过程

- HTML 被 HTML 解析器解析成 DOM 树
- css 则被 css 解析器解析成 CSSOM 树
- 结合 DOM 树和 CSSOM 树，生成一棵渲染树(Render Tree)
- 生成布局（flow），即将所有渲染树的所有节点进行平面合成
- 将布局绘制（paint）在屏幕上

第四步和第五步是最耗时的部分，这两步合起来，就是我们通常所说的**渲染**。

重绘不一定需要重排，重排必然会导致重绘

## 二、重排(reflow)

### 概念：

当 DOM 的变化影响了元素的几何信息(DOM 对象的位置和尺寸大小)，浏览器需要重新计算元素的几何属性，将其安放在界面中的正确位置，这个过程叫做重排。

重排也叫回流,重排的过程以下面这种理解方式更清晰一些：

> 回流就好比向河里(文档流)扔了一块石头(dom 变化)，激起涟漪，然后引起周边水流受到波及，所以叫做回流

常见引起重排属性和方法

任何会改变元素几何信息(元素的位置和尺寸大小)的操作，都会触发重排，下面列一些栗子：

- 1）添加、删除可见的 dom

- 2）元素的位置改变

- 3）元素的尺寸改变（外边距、内边距、边框厚度、宽高等几何属性）

- 4）页面渲染初始化

- 5）浏览器窗口尺寸改变

- 6） 内容变化，比如用户在 input 框中输入文字

### 常见的引起重排的属性和方法

![](https://yangblogimg.oss-cn-hangzhou.aliyuncs.com/blogImg/重排属性方法.png)

## 三、重绘(Repaints)

### 概念

当一个元素的外观发生改变，但没有改变布局,重新把元素外观绘制出来的过程，叫做重绘。

### 常见的引起重绘的属性和方法

![](https://yangblogimg.oss-cn-hangzhou.aliyuncs.com/blogImg/重绘属性.png)

## 四、关键点

**重绘不一定需要重排，重排必然会导致重绘**

## 五、浏览器的渲染队列

### 正常渲染队列

思考以下代码将会触发几次渲染？

```js
div.style.left = '10px';
div.style.top = '10px';
div.style.width = '20px';
div.style.height = '20px';
```

根据我们上文的定义，这段代码理论上会触发`4次`重排+重绘，因为每一次都改变了元素的几何属性，实际上最后只触发了一次重排，这都得益于浏览器的**渲染队列机制**：

当我们修改了元素的几何属性，导致浏览器触发重排或重绘时。它会把该操作放进渲染队列，等到队列中的操作到了**一定的数量或者到了一定的时间间隔**时，浏览器就会批量执行这些操作。

### 强制刷新队列:

```js
div.style.left = '10px';
console.log(div.offsetLeft);
div.style.top = '10px';
console.log(div.offsetTop);
div.style.width = '20px';
console.log(div.offsetWidth);
div.style.height = '20px';
console.log(div.offsetHeight);
```

这段代码会触发 4 次重排+重绘，因为在 console 中你请求的这几个样式信息，无论何时浏览器都会立即执行渲染队列的任务，即使该值与你操作中修改的值没关联。

**因为队列中，可能会有影响到这些值的操作，为了给我们最精确的值，浏览器会立即重排+重绘。**
