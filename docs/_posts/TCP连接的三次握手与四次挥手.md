---
title: TCP连接的三次握手与四次挥手
date: 2020-10-23 10:53:30
tags:
  - 计算机网络
  - TCP
categories:
  - 计算机网络
copyright: true
permalink: /pages/a2ddc3/
sidebar: auto
author:
  name: 杨雨翔
  link: https://github.com/gezhicui
---

#

&emsp;&emsp;客户端与服务器之间数据的发送和返回的过程当中需要创建一个叫`TCP connection`的东西；由于 TCP 不存在连接的概念，只存在请求和响应，请求和响应都是数据包，它们之间都是经过由 TCP 创建的一个从客户端发起，服务器接收的类似连接的通道，这个连接可以一直保持，http 请求是在这个连接的基础上发送的。
在一个 TCP 连接上是可以发送多个 http 请求的，不同的版本这个模式不一样。

- 在 HTTP/1.0 中这个 TCP 连接是在 http 请求创建的时候同步创建的，http 请求发送到服务器端，服务器端响应了之后，这个 TCP 连接就关闭了；
- HTTP/1.1 中可以以某种方式声明这个连接一直保持，一个请求传输完之后，另一个请求可以接着传输。这样的好处是：在创建一个 TCP 连接的过程中需要“三次握手”的消耗，“三次握手”代表有三次网络传输。

&emsp;&emsp;如果 TCP 连接保持，第二个请求发送就没有这“三次握手”的消耗。HTTP/2 中同一个 TCP 连接里还可以并发地传输 http 请求。

## TCP 报文格式简介

![](https://yangblogimg.oss-cn-hangzhou.aliyuncs.com/blogImg/TCp.png)

其中比较重要的字段有：

(1)序号 (sequence number )：Seq 序号,占 32 位,用来标识从 TCP 源端向目的端发送的字节流,发起方发送数据时对此进行标记。

(2)确认号 (acknowledgement number )：Ack 序号,占 32 位,只有 ACK 标志位为 1 时,确认序号字段才有效,Ack=Seq+1。

(3)标志位 (Flags )：共 6 个,即 URG、ACK、PSH、RST、SYN、FIN 等。具体含义如下：

- URG：紧急指针 (urgent pointer )有效。
- ACK：确认序号有效。
- PSH：接收方应该尽快将这个报文交给应用层。
- RST：重置连接。
- SYN：发起一个新连接。
- FIN：释放一个连接。

## TCP 的三次握手

&emsp;&emsp;所谓的三次握手即 TCP 连接的建立。这个连接必须是一方主动打开，另一方被动打开的。以下为客户端主动发起连接的图解：

![](https://yangblogimg.oss-cn-hangzhou.aliyuncs.com/blogImg/三次握手.png)

### 三次握手过程

- 第一次：客户端发送初始序号 x 和 syn=1 请求标志
- 第二次：服务器发送请求标志 syn，发送确认标志 ACK，发送自己的序号 seq=y，发送客户端的确认序号 ack=x+1
- 第三次：客户端发送 ACK 确认号，发送自己的序号 seq=x+1，发送对方的确认号 ack=y+1

### 为什么需要三次握手？

&emsp;&emsp;譬如发起请求遇到类似这样的情况：客户端发出去的第一个连接请求由于某些原因在网络节点中滞留了导致延迟，直到连接释放的某个时间点才到达服务端，这是一个早已失效的报文，但是此时服务端仍然认为这是客户端的建立连接请求第一次握手，于是服务端回应了客户端，第二次握手。
&emsp;&emsp;如果只有两次握手，那么到这里，连接就建立了，但是此时客户端并没有任何数据要发送，因为这是一个已经废弃的请求，而服务端还在傻傻的等候佳音，造成很大的资源浪费。所以需要第三次握手，只有客户端再次回应一下，就可以避免这种情况。

## TCP 四次挥手

### 四次挥手过程

![](https://yangblogimg.oss-cn-hangzhou.aliyuncs.com/blogImg/四次挥手.png)

- 第一次：由客户端向服务端发起，发送 FIN,seq=u。**服务端收到信息后就能确定客户端已经停止发送数据**。
- 第二次：由服务端向客户端发起，**客户端收到消息后就能确定服务端已经知道客户端不会再发送数据**。发送 ACK,ack=u+1,seq=v
- 第三次：服务器请求断开。由服务端向客户端发起，**客户端收到消息后就能确定服务端已经停止发送数据**。FIN,seq=w,ACK,ack=u+1
- 第四次：由客户端向服务端发起，服务端收到信息后就能确定客户端已经知道服务端不会再发送数据。**客户端确认服务器的断开**ACK,ack=w+1,seq=u+1

### 为什么需要四次挥手？

在客服端第 1 次挥手时，服务端可能还在发送数据。所以第 2 次挥手和第 3 次挥手不能合并。
